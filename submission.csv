# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix
import warnings

# warningsã‚’éè¡¨ç¤ºã«è¨­å®š
warnings.filterwarnings('ignore')

## 1. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨ç¢ºèª (Step 1)
print("===== Step 1: ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨ç¢ºèª =====")

# ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ (ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯å¿…ãšã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¦ãã ã•ã„)
# ä¾‹: train_df = pd.read_csv('./train.csv')
train_df = pd.read_csv('/kaggle/input/muds-ml-and-dl-2025-test/train.csv')
test_df = pd.read_csv('/kaggle/input/muds-ml-and-dl-2025-test/test.csv')

print(f"è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚º: {train_df.shape[0]}è¡Œ Ã— {train_df.shape[1]}åˆ—")
print(f"ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚º: {test_df.shape[0]}è¡Œ Ã— {test_df.shape[1]}åˆ—")
print("\n--------------------\n")

## 2. ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç† (Step 2)
print("===== Step 2: ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç† =====")

# IDã¨äºˆæ¸¬å¯¾è±¡ã‚’åˆ†é›¢
test_ids = test_df['ID']

# äºˆæ¸¬å¯¾è±¡ ('Attrition') ã‚’æ•°å€¤ã«å¤‰æ› ('Yes' -> 1, 'No' -> 0)
y = train_df['Attrition'].map({'Yes': 1, 'No': 0})

# ç‰¹å¾´é‡ (IDã¨Attritionã‚’é™¤å¤–)
X = train_df.drop(['ID', 'Attrition'], axis=1)
X_test = test_df.drop(['ID'], axis=1)

# ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ«å¤‰æ•°ï¼ˆæ–‡å­—åˆ—å‹ï¼‰ã‚’ç‰¹å®š
categorical_features = X.select_dtypes(include=['object']).columns.tolist()

# LabelEncoderã§æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›
for col in categorical_features:
    le = LabelEncoder()
    # è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’çµåˆã—ã¦å¤‰æ›
    combined = pd.concat([X[col], X_test[col]], axis=0).astype(str)
    le.fit(combined)
    
    X[col] = le.transform(X[col])
    X_test[col] = le.transform(X_test[col])

print("âœ” æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã—ã¾ã—ãŸ")

# å½¹ã«ç«‹ãŸãªã„åˆ—ã‚’å‰Šé™¤ (å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã§åŒã˜å€¤ã‚’æŒã¤ã¨ä»®å®šã•ã‚Œã‚‹åˆ—)
useless_cols = ['EmployeeCount', 'StandardHours', 'Over18']
useless_cols = [col for col in useless_cols if col in X.columns] 

X = X.drop(useless_cols, axis=1)
X_test = X_test.drop(useless_cols, axis=1)

print(f"âœ” ä¸è¦ãªåˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: {useless_cols}")
print("\n--------------------\n")

## 3. ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ã¨è©•ä¾¡ (Step 3)
print("===== Step 3: ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ã¨è©•ä¾¡ =====")

# è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚’è¨“ç·´ç”¨(80%)ã¨æ¤œè¨¼ç”¨(20%)ã«åˆ†å‰²
X_train, X_valid, y_train, y_valid = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

# ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆã¨è¨“ç·´
model = LogisticRegression(max_iter=1000, random_state=42)
print("å­¦ç¿’ä¸­...")
model.fit(X_train, y_train)
print("âœ” å­¦ç¿’å®Œäº†!")

# ãƒ¢ãƒ‡ãƒ«ã®æ€§èƒ½è©•ä¾¡ (æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã§äºˆæ¸¬)
y_pred = model.predict(X_valid)

# æ­£è§£ç‡ (Accuracy) ã®è¨ˆç®—
accuracy = accuracy_score(y_valid, y_pred)
print(f"\nãƒ¢ãƒ‡ãƒ«ã®æ­£è§£ç‡ (Accuracy): {accuracy:.4f} ({accuracy*100:.2f}%)")
print("\n--------------------\n")

## 4. å­¦ç¿’ã—ãŸãƒ¢ãƒ‡ãƒ«ã§ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’äºˆæ¸¬ (Step 4)
print("===== Step 4: å­¦ç¿’ã—ãŸãƒ¢ãƒ‡ãƒ«ã§ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’äºˆæ¸¬ =====")

# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’ä½¿ã£ã¦äºˆæ¸¬ã‚’è¡Œã† (0ã‹1ã‚’è¿”ã™)
test_predictions = model.predict(X_test)

print(f"\näºˆæ¸¬å®Œäº†: {len(test_predictions)}ä»¶")
print(f"é›¢è·ã‚ã‚Šã¨äºˆæ¸¬ (1): {(test_predictions == 1).sum()}ä»¶")
print(f"é›¢è·ãªã—ã¨äºˆæ¸¬ (0): {(test_predictions == 0).sum()}ä»¶")
print("\n--------------------\n")

## 5. æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ submission.csv ã¨ã—ã¦ä¿å­˜ (Step 5)
print("===== Step 5: æå‡ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä¿å­˜ =====")

# 0/1 ã‚’ 'Yes'/'No' ã«æˆ»ã™
test_pred_labels = pd.Series(test_predictions).map({1: 'Yes', 0: 'No'})

# æå‡ºç”¨ã®DataFrameã‚’ä½œæˆ (IDã¨äºˆæ¸¬çµæœã®2åˆ—)
submission = pd.DataFrame({
    'ID': test_ids,
    'Attrition': test_pred_labels
})

# CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ (Kaggle/working ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã‚‹)
submission.to_csv('submission.csv', index=False)

print(f"\nâœ” submission.csv ã‚’ä½œæˆã—ã¾ã—ãŸ! ã‚µã‚¤ã‚º: {submission.shape[0]}è¡Œ Ã— {submission.shape[1]}åˆ—")
print("å…ˆé ­5è¡Œ:")
print(submission.head())

print("\nå®Œäº†! ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Kaggleã«æå‡ºã—ã¾ã—ã‚‡ã†! ğŸš€")